# Copyright 2024 RustFS Team
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Build and Release Workflow
#
# This workflow builds RustFS binaries and automatically triggers Docker image builds.
#
# Flow:
# 1. Build binaries for multiple platforms
# 2. Upload binaries to OSS storage
# 3. Trigger docker.yml to build and push images using the uploaded binaries
#

name: Release Build x86_64-unknown-linux-musl

on:
  workflow_dispatch:
    inputs:
      TOOLCHAINS:
        type: choice
        description: "‰ΩøÁî®ÁöÑÂ∑•ÂÖ∑Èìæ"
        required: true
        default: "nightly"
        options:
          - "stable"
          - "nightly"
      USE_MIMALLOC:
        type: boolean
        description: "ÊòØÂê¶‰ΩøÁî®mimallocÊõøÊç¢tikv-jemallocÔºü"
        required: true
        default: true
      THIN_LTO:
        type: boolean
        description: "ÊòØÂê¶ÂºÄÂêØthin-ltoÂä†ÈÄüÁºñËØëÊèêÂçáÁ®≥ÂÆöÊÄßÔºü"
        required: true
        default: false
      CLIPPY_FIX:
        type: boolean
        description: "ÊòØÂê¶Âº∫Âà∂ÊÄßÊèêÂçá‰ª£Á†ÅË¥®ÈáèÔºü"
        required: true
        default: false
env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # Optimize build performance
  CARGO_INCREMENTAL: 0

jobs:
  # Build strategy check - determine build type based on trigger
  build-check:
    name: Build Strategy Check
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      build_type: ${{ steps.check.outputs.build_type }}
      version: ${{ steps.check.outputs.version }}
      short_sha: ${{ steps.check.outputs.short_sha }}
      is_prerelease: ${{ steps.check.outputs.is_prerelease }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Determine build strategy
        id: check
        run: |
          should_build=false
          build_type="none"
          version=""
          short_sha=""
          is_prerelease=false

          # Get short SHA for all builds
          short_sha=$(git rev-parse --short HEAD)

          # Determine build type based on trigger
          if [[ "${{ startsWith(github.ref, 'refs/tags/') }}" == "true" ]]; then
            # Tag push - release or prerelease
            should_build=true
            tag_name="${GITHUB_REF#refs/tags/}"
            version="${tag_name}"

            # Check if this is a prerelease
            if [[ "$tag_name" == *"alpha"* ]] || [[ "$tag_name" == *"beta"* ]] || [[ "$tag_name" == *"rc"* ]]; then
              build_type="prerelease"
              is_prerelease=true
              echo "üöÄ Prerelease build detected: $tag_name"
            else
              build_type="release"
              echo "üì¶ Release build detected: $tag_name"
            fi
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            # Main branch push - development build
            should_build=true
            build_type="development"
            version="dev-${short_sha}"
            echo "üõ†Ô∏è  Development build detected"
          elif [[ "${{ github.event_name }}" == "schedule" ]] || \
               [[ "${{ github.event_name }}" == "workflow_dispatch" ]] || \
               [[ "${{ contains(github.event.head_commit.message, '--build') }}" == "true" ]]; then
            # Scheduled or manual build
            should_build=true
            build_type="development"
            version="dev-${short_sha}"
            echo "‚ö° Manual/scheduled build detected"
          fi

          echo "should_build=$should_build" >> $GITHUB_OUTPUT
          echo "build_type=$build_type" >> $GITHUB_OUTPUT
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "short_sha=$short_sha" >> $GITHUB_OUTPUT
          echo "is_prerelease=$is_prerelease" >> $GITHUB_OUTPUT

          echo "üìä Build Summary:"
          echo "  - Should build: $should_build"
          echo "  - Build type: $build_type"
          echo "  - Version: $version"
          echo "  - Short SHA: $short_sha"
          echo "  - Is prerelease: $is_prerelease"

  # Build RustFS binaries
  build-rustfs:
    name: Build RustFS
    needs: [build-check]
    if: needs.build-check.outputs.should_build == 'true'
    runs-on: ${{ matrix.os }}
    timeout-minutes: 120
    env:
      RUSTFLAGS: ${{ matrix.cross == 'false' && '-C target-cpu=native' || '' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux builds
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            cross: true
            platform: linux
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Rust environment
        uses: ./.github/actions/setup
        with:
          rust-version: ${{ github.event.inputs.TOOLCHAINS }}
          target: ${{ matrix.target }}          
          github-token: ${{ secrets.GITHUB_TOKEN }}
          install-cross-tools: ${{ matrix.cross }}

      - name: Clone rustfs sources
        run: |
          git clone --depth 1 https://github.com/rustfs/rustfs rustfs_tmpdir
          mv rustfs_tmpdir/*  .
          rm -rf rustfs_tmpdir
          
      - name: Configure Git
        run: |
          git config --global user.name "Numbersf"
          git config --global user.email "263623064@qq.com"

      - name: Build static console assets
        shell: bash
        run: |
          git clone --depth 1 https://github.com/rustfs/console rustfs_consule
          cd rustfs_consule
          rm -f *lock*
          npm install -g pnpm
          pnpm add -D @types/lodash
          pnpm add lodash-es
          pnpm add -D @types/lodash-es
          pnpm update; pnpm upgrade
          pnpm install --no-frozen-lockfile
          git add  . && git commit -m "auto commit" || true
          for i in "fix_seemly.patch" \
            "fix_loaddash.patch" \
            "default_admin.patch"; do
             wget https://github.com/reigadegr/rustfs_compile/raw/main/patchs/$i
             patch -p1 -F 3 < $i && git add  . && git commit -m "auto commit" || git reset --hard
             git clean -df
          done
          NITRO_PRESET=static pnpm build
          cd  ..
          mkdir -p ./rustfs/static
          cp -rf rustfs_consule/dist/* ./rustfs/static
          rm -rf rustfs_consule || echo "Âà†Èô§ÂâçÁ´ØÂÜó‰ΩôËµÑÊ∫êÂ§±Ë¥•"
          rm -rf .pnpm* || echo "Âà†Èô§ÂâçÁ´ØÂÜó‰ΩôËµÑÊ∫ê.pnpmÂ§±Ë¥•"

      - name: Setup TimeZone
        run: |
          sudo -E rm -rf /etc/localtime
          sudo -E ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
  
      - name: Fix upstream bugs
        run: |
          git init || echo "Êó†ÈúÄinit"
          rm -rf target && echo "Âà†Èô§‰∫Ütarget" || echo "Êó†ÈúÄÂà†Èô§"
          git add  . && git commit -m "auto commit"
          if [ "${{ github.event.inputs.USE_MIMALLOC }}" = "true" ]; then
            malloc="use_mimalloc.patch"
          else
            malloc="jemalloc_musl_fix.patch"
          fi
          for i in "disable_scanner.patch" \
            "$malloc" \
            "full_opt.patch"; do
             wget https://github.com/reigadegr/rustfs_compile/raw/main/patchs/$i
             patch -p1 -F 3 < $i && git add  . && git commit -m "auto commit" || git reset --hard
             git clean -df
          done

      - name: Thin lto
        if: ${{ github.event.inputs.THIN_LTO == 'true' }}
        run: |
          git init || echo "Êó†ÈúÄinit"
          rm -rf target && echo "Âà†Èô§‰∫Ütarget" || echo "Êó†ÈúÄÂà†Èô§"
          git add  . && git commit -m "auto commit" || echo "Êó†ÈúÄÊèê‰∫§"
          for i in "thin_lto.patch"; do
             wget https://github.com/reigadegr/rustfs_compile/raw/main/patchs/$i
             patch -p1 -F 3 < $i && git add  . && git commit -m "auto commit" || git reset --hard
             git clean -df
          done

      - name: Clippy force fix
        if: ${{ github.event.inputs.CLIPPY_FIX == 'true' }}
        run: |
          git init || echo "Êó†ÈúÄinit"
          echo target >.gitignore
          rm -rf target && echo "Âà†Èô§‰∫Ütarget" || echo "Êó†ÈúÄÂà†Èô§"
          git add  . && git commit -m "auto commit" || echo "Êó†ÈúÄÊèê‰∫§"
          work_space="$(pwd)"
          for i in $(ls $(realpath ./crates)); do
            git add  . && git commit -m "auto commit" || echo "Êó†ÈúÄÊèê‰∫§"
            i="$(realpath "$work_space/crates/$i")"
            cd $i
            sed -i '1i #![warn(clippy::nursery, clippy::pedantic, clippy::style, clippy::complexity, clippy::perf, clippy::correctness)]' src/lib.rs || true
            if [ -f "src/main.rs" ]; then
                sed -i '1i #![warn(clippy::nursery, clippy::pedantic, clippy::style, clippy::complexity, clippy::perf, clippy::correctness)]' src/main.rs
            fi
            git add  . && git commit -m "auto commit" || echo "Êó†ÈúÄÊèê‰∫§"
            cargo clippy --fix --allow-dirty --allow-staged -- -W clippy::all -W clippy::pedantic -W clippy::cargo -W clippy::nursery -W clippy::style -W clippy::complexity -W clippy::perf -W clippy::correctness  -A clippy::restriction >/dev/null 2>&1 || continue
            git add  . && git commit -m "auto commit" || echo "Êó†ÈúÄÊèê‰∫§"
          done
          cd "$work_space"/rustfs
          cargo clippy --fix --allow-dirty --allow-staged -- -W clippy::all -W clippy::pedantic -W clippy::cargo -W clippy::nursery -W clippy::style -W clippy::complexity -W clippy::perf -W clippy::correctness  -A clippy::restriction >/dev/null 2>&1 || echo "‰øÆrustfs‰∏ªÊ®°ÂùóÂá∫Èîô"

      - name: Build RustFS
        shell: bash
        run: |
          rm -rf target && echo "Âà†Èô§‰∫Ütarget" || echo "Êó†ÈúÄÂà†Èô§"
          # Force rebuild by touching build.rs
          touch rustfs/build.rs
          if [ "${{ github.event.inputs.TOOLCHAINS }}" = "nightly" ]; then
            sh build_nightly.sh "${{ matrix.target }}"
          else
            sh build_stable.sh "${{ matrix.target }}"
          fi

      - name: Upload to GitHub artifacts
        uses: actions/upload-artifact@v4
        with:
          name: x86_64_linux_musl_rustfs
          path: x86_64-unknown-linux-musl_module/rustfs
          retention-days: 1

  # Build minio client binaries
  build-mc:
    name: Build MC
    needs: [build-check]
    if: needs.build-check.outputs.should_build == 'true'
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    env:
      RUSTFLAGS: ${{ matrix.cross == 'false' && '-C target-cpu=native' || '' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux builds
          - os: ubuntu-latest
            target: amd64
            cross: true
            platform: linux
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.x'

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install git clang llvm

      - name: Configure Git
        run: |
          git config --global user.name "Numbersf"
          git config --global user.email "263623064@qq.com"
          
      - name: Setup TimeZone
        run: |
          sudo -E rm -rf /etc/localtime
          sudo -E ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

      - name: Clone minio client sources
        run: |
          git clone --depth 1 https://github.com/minio/mc mc_tmpdir
          mv mc_tmpdir/*  .
          rm -rf mc_tmpdir

      - name: Build Minio Client
        shell: bash
        run: |
          export GOOS="${{ matrix.platform }}" CGO_ENABLED=0
          export GOARCH="${{ matrix.target }}"
          go build -trimpath -ldflags "-s -w" -gcflags="all=-B -dwarf=false"

      - name: Upload to GitHub artifacts
        uses: actions/upload-artifact@v4
        with:
          name: x86_64_linux_mc
          path: mc
          retention-days: 1

  integration-magisk:
    name: Integration Magisk
    needs: [build-rustfs, build-mc]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      
      - name: Download mc
        uses: actions/download-artifact@v4
        with:
          name: x86_64_linux_mc

      - name: Download rustfs
        uses: actions/download-artifact@v4
        with:
          name: x86_64_linux_musl_rustfs

      - name: Production magisk module
        run: |
          ls -al
          file *
          mv mc x86_64-unknown-linux-musl_module
          mv rustfs x86_64-unknown-linux-musl_module
       
      - name: Upload release version
        uses: actions/upload-artifact@v4
        with:
          name: x86_64_linux_musl_rustfs_product
          compression-level: 9
          path: x86_64-unknown-linux-musl_module/*

  # Build summary
  build-summary:
    name: Build Summary
    needs: [build-rustfs, build-mc]
    if: always() && needs.build-check.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Build completion summary
        shell: bash
        run: |
          BUILD_TYPE="${{ needs.build-check.outputs.build_type }}"
          VERSION="${{ needs.build-check.outputs.version }}"

          echo "üéâ Build completed successfully!"
          echo "üì¶ Build type: $BUILD_TYPE"
          echo "üî¢ Version: $VERSION"
          echo ""

          # Check build status
          BUILD_STATUS="${{ needs.build-rustfs.result }}"

          echo "üìä Build Results:"
          echo "  üì¶ All platforms: $BUILD_STATUS"
          echo ""

          case "$BUILD_TYPE" in
            "development")
              echo "üõ†Ô∏è  Development build artifacts have been uploaded to OSS dev directory"
              echo "‚ö†Ô∏è  This is a development build - not suitable for production use"
              ;;
            "release")
              echo "üöÄ Release build artifacts have been uploaded to OSS release directory"
              echo "‚úÖ This build is ready for production use"
              echo "üè∑Ô∏è  GitHub Release will be created in this workflow"
              ;;
            "prerelease")
              echo "üß™ Prerelease build artifacts have been uploaded to OSS release directory"
              echo "‚ö†Ô∏è  This is a prerelease build - use with caution"
              echo "üè∑Ô∏è  GitHub Release will be created in this workflow"
              ;;
          esac

          echo ""
